<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Dashboard</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 bg-light p-3">
            <h4>Account Viewer</h4>
            <div class="btn-group-vertical w-100" role="group">
                <button class="btn btn-primary mb-2" onclick="viewAllAccounts()">View All Accounts</button>
                <button class="btn btn-secondary mb-2" onclick="showFindById()">Find Account by ID</button>
                <button class="btn btn-success mb-2" onclick="showCreateAccount()">Create Account</button>
                <button class="btn btn-info mb-2" onclick="showUpdateById()">Update Account by ID</button>
                <button class="btn btn-danger mb-2" onclick="showDeleteById()">Delete Account by ID</button>
            </div>

            <h4 class="mt-4">Contact Viewer</h4>
            <div class="btn-group-vertical w-100" role="group">
                <button class="btn btn-primary mb-2" onclick="viewAllContacts()">View All Contacts</button>
                <button class="btn btn-secondary mb-2" onclick="showFindContactById()">Find Contact by ID</button>
                <button class="btn btn-success mb-2" onclick="showCreateContact()">Create Contact</button>
                <button class="btn btn-warning mb-2" onclick="showCreateDummyContacts()">Create Dummy Contact(s)</button>
                <button class="btn btn-info mb-2" onclick="showUpdateContactById()">Update Contact by ID</button>
                <button class="btn btn-danger mb-2" onclick="showDeleteContactById()">Delete Contact by ID</button>
            </div>
        </div>

        <!-- Main Output Area -->
        <div class="col-md-9 p-3" id="output-area">
            <h4>Welcome! Select an option on the left.</h4>
        </div>
    </div>
</div>

<script>
let accountsCache = {};

function fetchAccountsCache(callback) {
    if (Object.keys(accountsCache).length > 0) {
        callback();
        return;
    }
    $.get("/accounts", function(data) {
        data.forEach(acc => {
            accountsCache[acc.id] = acc.name || '';
        });
        callback();
    });
}

function showFindContactById() {
    $('#output-area').html(`
        <h4>Find Contact by ID</h4>
        <input id="find-contact-id" type="number" class="form-control mb-2" placeholder="Enter Contact ID">
        <button class="btn btn-primary" onclick="findContactById()">Find</button>
        <div id="contact-result" class="mt-3"></div>
    `);
}

function findContactById() {
    const id = $('#find-contact-id').val();
    fetchAccountsCache(() => {
        $.get(`/contacts/${id}`, function(contact) {
            const accName = accountsCache[contact.account_id] || 'N/A';
            const html = `<table class="table"><tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Email</th><th>Account Name</th><th>Health Score</th></tr>
                          <tr><td>${contact.id}</td><td>${contact.first_name}</td><td>${contact.last_name}</td><td>${contact.email}</td><td>${accName}</td><td>${contact.health_score ?? ''}</td></tr></table>`;
            $('#contact-result').html(html);
        }).fail(() => $('#contact-result').html('<div class="text-danger">Contact not found.</div>'));
    });
}

function showDeleteContactById() {
    $('#output-area').html(`
        <h4>Delete Contact by ID</h4>
        <input id="delete-contact-id" type="number" class="form-control mb-2" placeholder="Enter Contact ID">
        <button class="btn btn-danger" onclick="deleteContactById()">Delete</button>
        <div id="delete-contact-result" class="mt-3"></div>
    `);
}

function deleteContactById() {
    const id = $('#delete-contact-id').val();
    fetchAccountsCache(() => {
        $.ajax({
            url: `/contacts/${id}`,
            method: 'DELETE',
            success: function(res) {
                const accName = accountsCache[res.account_id] || 'N/A';
                const html = `<div class="text-success">Deleted Contact:</div>
                              <table class="table"><tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Email</th><th>Account Name</th><th>Health Score</th></tr>
                              <tr><td>${res.id}</td><td>${res.first_name}</td><td>${res.last_name}</td><td>${res.email}</td><td>${accName}</td><td>${res.health_score ?? ''}</td></tr></table>`;
                $('#delete-contact-result').html(html);
            },
            error: () => $('#delete-contact-result').html('<div class="text-danger">Deletion failed.</div>')
        });
    });
}

function showUpdateContactById() {
    fetchAccountsCache(() => {
        let optionsHtml = '';
        for (const id in accountsCache) {
            optionsHtml += `<option value="${id}">${accountsCache[id]}</option>`;
        }
        $('#output-area').html(`
            <h4>Update Contact by ID</h4>
            <input id="update-contact-id" type="number" class="form-control mb-2" placeholder="Enter Contact ID">
            <input id="update-contact-first-name" type="text" class="form-control mb-2" placeholder="First Name">
            <input id="update-contact-last-name" type="text" class="form-control mb-2" placeholder="Last Name">
            <input id="update-contact-email" type="email" class="form-control mb-2" placeholder="Email">
            <select id="update-contact-account-id" class="form-control mb-2">
                ${optionsHtml}
            </select>
            <input id="update-contact-health-score" type="number" step="0.01" class="form-control mb-2" placeholder="Health Score">
            <button class="btn btn-info" onclick="updateContactById()">Update</button>
            <div id="update-contact-result" class="mt-3"></div>
        `);
    });
}
</script>
</body>
</html>
